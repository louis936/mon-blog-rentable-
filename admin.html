<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panneau Admin – Comparateur Premium</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
    header, footer { background: #333; color: white; padding: 1rem; text-align: center; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #eee; cursor: pointer; }
    input, select, button { margin: 0.5rem 0; padding: 0.5rem; width: 100%; max-width: 500px; }
    form button, .actions button { width: auto; }
    tr:hover { background: #f9f9f9; }
  </style>
</head>
<body>

<header>
  <h1>🛠️ Panneau d’administration</h1>
  <a href="index.html" style="color:white;">← Retour à l’accueil</a>
</header>

<div id="menu-utilisateur" style="text-align:center; margin:1rem 0;"></div>

<section id="admin-section">
  <!-- 🔐 Formulaire d'ajout ou de modification -->
  <h2>➕ Ajouter un produit</h2>
  <form id="form-ajout" onsubmit="ajouterProduit(event)">
    <input type="text" id="nom" placeholder="Nom du produit" required />
    <input type="text" id="description" placeholder="Description" required />
    <input type="number" id="prix" placeholder="Prix en €" required />
    <input type="text" id="categorie" placeholder="Catégorie" required />
    <input type="text" id="image" placeholder="URL image" required />
    <input type="text" id="annonceur" placeholder="Annonceur" required />
    <input type="text" id="url" placeholder="Lien du produit" required />
    <button type="submit">Ajouter ✅</button>
  </form>

  <!-- 🔍 Filtres & recherche -->
  <div style="margin:1rem 0;">
    <label for="filtre-categorie"><strong>Filtrer par catégorie :</strong></label>
    <select id="filtre-categorie" onchange="filtrerCategorie(this.value)">
      <option value="">— Toutes —</option>
    </select>

    <input type="text" id="recherche" oninput="filtrerRecherche(this.value)" placeholder="🔎 Recherche nom..." style="margin-left:1rem;" />
    <button onclick="exporterCSV()" style="float:right;">📤 Export CSV</button>
  </div>

  <!-- 📦 Tableau des produits -->
  <table id="table-produits">
    <thead>
      <tr>
        <th onclick="trier('produit_id')">ID 🔼</th>
        <th onclick="trier('nom')">Nom</th>
        <th onclick="trier('prix')">Prix</th>
        <th onclick="trier('annonceur')">Annonceur</th>
        <th onclick="trier('categorie')">Catégorie</th>
        <th onclick="trier('vues')">Vues</th>
        <th onclick="trier('clics')">Clics</th>
        <th onclick="trier('epc')">EPC</th>
        <th>✏️</th>
        <th>🗑️</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="10">Chargement...</td></tr>
    </tbody>
  </table>
</section>

<footer>
  <p>🔒 Interface admin sécurisée – Comparateur Premium</p>
</footer>
    <script>
const API_URL = "http://localhost:8000";
let produits = [];
let triColonne = "produit_id";
let triAscendant = true;
let filtreCategorie = "";
let termeRecherche = "";

window.onload = async () => {
  const utilisateurId = localStorage.getItem("utilisateur_id");
  if (!utilisateurId) {
    alert("🔒 Accès refusé. Connecte-toi.");
    return (window.location.href = "login.html");
  }

  const menu = document.getElementById("menu-utilisateur");
  try {
    const res = await fetch(`${API_URL}/utilisateur/${utilisateurId}`);
    const data = await res.json();
    if (!data.utilisateur.is_admin) {
      alert("🔐 Tu n'es pas admin !");
      return (window.location.href = "index.html");
    }

    menu.innerHTML = `
      <p>👑 Connecté en tant que <strong>${data.utilisateur.nom}</strong> (Admin)</p>
      <button onclick="deconnexion()" style="margin-top:0.5rem;">Se déconnecter</button>
    `;

    chargerProduits();
  } catch (e) {
    alert("❌ Erreur de vérification admin.");
    console.error(e);
  }
};

function deconnexion() {
  localStorage.clear();
  window.location.href = "index.html";
}

function chargerProduits() {
  fetch(`${API_URL}/admin/produits`)
    .then(res => res.json())
    .then(data => {
      produits = data.produits || [];
      const categories = [...new Set(produits.map(p => p.categorie))];
      const select = document.getElementById("filtre-categorie");
      select.innerHTML = `<option value="">— Toutes —</option>`;
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
      afficherProduits();
    })
    .catch(e => {
      console.error("Erreur chargement produits", e);
    });
}

function afficherProduits() {
  const tbody = document.querySelector("#table-produits tbody");
  tbody.innerHTML = "";

  let produitsFiltres = produits
    .filter(p => !filtreCategorie || p.categorie === filtreCategorie)
    .filter(p => p.nom.toLowerCase().includes(termeRecherche.toLowerCase()));

  produitsFiltres.sort((a, b) => {
    let valA = a[triColonne];
    let valB = b[triColonne];
    if (typeof valA === "string") valA = valA.toLowerCase();
    if (typeof valB === "string") valB = valB.toLowerCase();
    if (valA < valB) return triAscendant ? -1 : 1;
    if (valA > valB) return triAscendant ? 1 : -1;
    return 0;
  });

  if (produitsFiltres.length === 0) {
    tbody.innerHTML = `<tr><td colspan="10">Aucun produit trouvé.</td></tr>`;
    return;
  }

  produitsFiltres.forEach(p => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${p.produit_id}</td>
      <td>${p.nom}</td>
      <td>${p.prix} €</td>
      <td>${p.annonceur}</td>
      <td>${p.categorie}</td>
      <td>${p.vues}</td>
      <td>${p.clics}</td>
      <td>${p.epc}</td>
      <td><button onclick="modifierProduit(${p.produit_id})">✏️</button></td>
      <td><button onclick="supprimerProduit(${p.produit_id})">🗑️</button></td>
    `;
    tbody.appendChild(row);
  });
}

function trier(col) {
  triColonne = col;
  triAscendant = !triAscendant;
  afficherProduits();
}

function filtrerCategorie(cat) {
  filtreCategorie = cat;
  afficherProduits();
}

function filtrerRecherche(txt) {
  termeRecherche = txt;
  afficherProduits();
}
function ajouterProduit(event) {
  event.preventDefault();
  const produit = {
    nom: document.getElementById("nom").value,
    description: document.getElementById("description").value,
    prix: parseFloat(document.getElementById("prix").value),
    categorie: document.getElementById("categorie").value,
    image: document.getElementById("image").value,
    annonceur: document.getElementById("annonceur").value,
    url: document.getElementById("url").value
  };

  fetch(`${API_URL}/admin/produit`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(produit)
  })
    .then(res => res.json())
    .then(json => {
      if (json.status === "ok") {
        alert("✅ Produit ajouté !");
        document.getElementById("form-ajout").reset();
        chargerProduits();
      } else {
        alert("❌ Erreur : " + json.message);
      }
    })
    .catch(e => {
      alert("❌ Erreur lors de l’ajout.");
      console.error(e);
    });
}

function modifierProduit(id) {
  const produit = produits.find(p => p.produit_id === id);
  if (!produit) return;

  document.getElementById("nom").value = produit.nom;
  document.getElementById("description").value = produit.description;
  document.getElementById("prix").value = produit.prix;
  document.getElementById("categorie").value = produit.categorie;
  document.getElementById("image").value = produit.image;
  document.getElementById("annonceur").value = produit.annonceur;
  document.getElementById("url").value = produit.url;

  const bouton = document.querySelector("#form-ajout button");
  bouton.textContent = "Mettre à jour ✏️";
  bouton.style.background = "#f39c12";
  bouton.onclick = function (event) {
    event.preventDefault();
    const modif = {
      nom: document.getElementById("nom").value,
      description: document.getElementById("description").value,
      prix: parseFloat(document.getElementById("prix").value),
      categorie: document.getElementById("categorie").value,
      image: document.getElementById("image").value,
      annonceur: document.getElementById("annonceur").value,
      url: document.getElementById("url").value
    };

    fetch(`${API_URL}/admin/produit/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(modif)
    })
      .then(res => res.json())
      .then(json => {
        if (json.status === "ok") {
          alert("✅ Produit modifié !");
          document.getElementById("form-ajout").reset();
          bouton.textContent = "Ajouter ✅";
          bouton.style.background = "";
          bouton.onclick = ajouterProduit;
          chargerProduits();
        } else {
          alert("❌ Erreur modification.");
        }
      })
      .catch(e => {
        alert("❌ Erreur mise à jour.");
        console.error(e);
      });
  };
}

function supprimerProduit(id) {
  if (!confirm("Supprimer le produit ID " + id + " ?")) return;
  fetch(`${API_URL}/admin/produit/${id}`, { method: "DELETE" })
    .then(res => res.json())
    .then(json => {
      if (json.status === "ok") {
        alert("✅ Produit supprimé.");
        chargerProduits();
      } else {
        alert("❌ Échec suppression.");
      }
    })
    .catch(e => {
      console.error("Erreur suppression", e);
    });
}

function exporterCSV() {
  let lignes = ["ID,Nom,Prix,Annonceur,Catégorie,Vues,Clics,EPC"];
  const lignesTableau = document.querySelectorAll("#table-produits tbody tr");
  lignesTableau.forEach(tr => {
    const colonnes = [...tr.querySelectorAll("td")].slice(0, 8);
    const ligne = colonnes.map(td => `"${td.textContent}"`).join(",");
    lignes.push(ligne);
  });
  const blob = new Blob([lignes.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "produits.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>